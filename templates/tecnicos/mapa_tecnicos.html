{% extends "base.html" %}

{% block title %}Mapa de Técnicos - CyberOS{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>

<style>
    #mapa-tecnicos {
        width: 100%;
        height: 600px;
        border-radius: 14px;
        overflow: hidden;
        background: #0b1220; /* dark background for this page */
        box-shadow: 0 6px 18px rgba(2,6,23,0.6);
        border: 1px solid rgba(255,255,255,0.04);
    }
    
    .card-tecnico {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        margin-bottom: 15px;
    }
    
    .status-disponivel {
        background-color: #dcfce7;
        color: #166534;
    }
    
    .status-em_atendimento {
        background-color: #fef3c7;
        color: #92400e;
    }
    
    .status-ausente {
        background-color: #f3f4f6;
        color: #374151;
    }
    
    .status-ferias {
        background-color: #dbeafe;
        color: #1e40af;
    }
    
    .status-licenca {
        background-color: #fee2e2;
        color: #b91c1c;
    }
    
    /* Dark-mode friendly status badges */
    .status-disponivel {
        background-color: #065f46; /* darker green */
        color: #e6f9f0;
    }
    
    .status-em_atendimento {
        background-color: #92400e; /* amber/darker */
        color: #fff4e6;
    }
    
    .status-ausente {
        background-color: #374151; /* gray */
        color: #f3f4f6;
    }
    
    .status-ferias {
        background-color: #1e3a8a; /* blue */
        color: #e6eef8;
    }
    
    .status-licenca {
        background-color: #991b1b; /* red */
        color: #ffecec;
    }
    
    .card-header.bg-white, .card-header.bg-white.border-bottom {
        background-color: transparent !important;
        border-bottom: 1px solid rgba(255,255,255,0.04) !important;
        color: #e6eef8;
    }
    
    .badge.bg-primary {
        background-color: #2563eb;
        color: white;
    }
    
    .card-tecnico:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 15px rgba(0,0,0,0.15);
    }
    
    .card-tecnico.disponivel {
        border-left: 4px solid #10b981;
    }
    
    .card-tecnico.em_atendimento {
        border-left: 4px solid #f59e0b;
    }
    
    .card-tecnico.ausente {
        border-left: 4px solid #6b7280;
    }
    
    .card-tecnico.ferias {
        border-left: 4px solid #3b82f6;
    }
    
    .card-tecnico.licenca {
        border-left: 4px solid #ef4444;
    }
    
    .tecnico-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
        background-color: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: #4b5563;
    }
    
    .tecnico-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .status-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 20px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-disponivel {
        background-color: #dcfce7;
        color: #166534;
    }
    
    .status-em_atendimento {
        background-color: #fef3c7;
        color: #92400e;
    }
    
    .status-ausente {
        background-color: #f3f4f6;
        color: #374151;
    }
    
    .status-ferias {
        background-color: #dbeafe;
        color: #1e40af;
    }
    
    .status-licenca {
        background-color: #fee2e2;
        color: #b91c1c;
    }
    
    .atualizacao-recente {
        color: #10b981;
    }
    
    .atualizacao-antiga {
        color: #f59e0b;
    }
    
    .atualizacao-indisponivel {
        color: #6b7280;
    }
    
    .mapa-filtros {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .mapa-filtro {
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
        border: 1px solid #e5e7eb;
        transition: all 0.2s ease;
    }
    
    .mapa-filtro:hover {
        background-color: #f3f4f6;
    }
    
    .mapa-filtro.ativo {
        background-color: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }
    
    /* info-panel is defined earlier with dark-mode colors */
    
    /* Marcador com borda branca e sombra, aparência mais 'flat' e limpa */
    .custom-marker-tecnico {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        color: white;
        font-weight: 700;
        position: relative;
        border: 3px solid #ffffff; /* borda branca típica do Waze */
        box-shadow: 0 4px 10px rgba(2,6,23,0.18);
        font-size: 0.95rem;
        line-height: 1;
    }

    /* Ponteiro pequeno sob o marcador, mantendo cor do marcador */
    .custom-marker-tecnico::after {
        content: '';
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 8px solid inherit;
    }
    
    .marker-disponivel {
        background-color: #10b981;
    }
    
    .marker-em_atendimento {
        background-color: #f59e0b;
    }
    
    .marker-ausente {
        background-color: #6b7280;
    }
    
    .marker-ferias {
        background-color: #3b82f6;
    }
    
    .marker-licenca {
        background-color: #ef4444;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="mb-2"><i class="fas fa-map-marked-alt me-2"></i> Mapa de Técnicos</h1>
        <p class="text-muted">Visualize a localização dos técnicos em tempo real</p>
    </div>
    <div>
        <a href="{% url 'tecnicos:listar_tecnicos' %}" class="btn btn-outline-secondary">
            <i class="fas fa-list me-2"></i> Lista de Técnicos
        </a>
        <a href="{% url 'tecnicos:novo_tecnico' %}" class="btn btn-primary ms-2">
            <i class="fas fa-user-plus me-2"></i> Novo Técnico
        </a>
    </div>
</div>

<div class="alert alert-info alert-dismissible fade show mb-4">
    <i class="fas fa-info-circle me-2"></i> 
    O mapa mostra a última localização conhecida dos técnicos. Clique em um marcador para ver mais detalhes ou na linha do técnico na lista para centralizar o mapa em sua localização.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<div class="row mb-4">
    <div class="col-lg-8 mb-4 mb-lg-0">
        <!-- Painel de informações rápidas -->
        <div class="info-panel mb-4">
            <div class="row text-center">
                <div class="col-md-3 mb-3 mb-md-0">
                    <h5 class="mb-1">{{ total_tecnicos }}</h5>
                    <p class="text-muted mb-0">Total de Técnicos</p>
                </div>
                <div class="col-md-3 mb-3 mb-md-0">
                    <h5 class="mb-1">{{ total_com_coordenadas }}</h5>
                    <p class="text-muted mb-0">No Mapa</p>
                </div>
                <div class="col-md-3 mb-3 mb-md-0">
                    <h5 class="mb-1">{{ tecnicos_disponiveis }}</h5>
                    <p class="text-muted mb-0">Disponíveis</p>
                </div>
                <div class="col-md-3">
                    <h5 class="mb-1">{{ tecnicos_em_atendimento }}</h5>
                    <p class="text-muted mb-0">Em Atendimento</p>
                </div>
            </div>
        </div>
        
        <!-- Filtros do mapa -->
        <div class="mapa-filtros mb-4">
            <div class="mapa-filtro ativo" data-status="todos">Todos</div>
            <div class="mapa-filtro" data-status="disponivel">Disponíveis</div>
            <div class="mapa-filtro" data-status="em_atendimento">Em Atendimento</div>
            <div class="mapa-filtro" data-status="ausente">Ausentes</div>
            <div class="mapa-filtro" data-status="ferias">Férias</div>
            <div class="mapa-filtro" data-status="licenca">Licença</div>
        </div>
        
        <!-- Mapa -->
        <div id="mapa-tecnicos"></div>
    </div>
    
    <div class="col-lg-4">
        <!-- Lista de técnicos no mapa -->
        <div class="card">
            <div class="card-header bg-white border-bottom">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Técnicos no Mapa</h5>
                    <span class="badge bg-primary">{{ total_com_coordenadas }} de {{ total_tecnicos }}</span>
                </div>
            </div>
            <div class="card-body p-0" style="max-height: 510px; overflow-y: auto;">
                <div class="list-group list-group-flush">
                    {% for tecnico in tecnicos %}
                    <div class="list-group-item list-group-item-action p-3 tecnico-item" 
                         data-lat="{{ tecnico.latitude }}" 
                         data-lng="{{ tecnico.longitude }}"
                         data-status="{{ tecnico.status }}"
                         data-id="{{ tecnico.id }}">
                        <div class="d-flex">
                            <div class="tecnico-avatar me-3">
                                {% if tecnico.foto %}
                                <img src="{{ tecnico.foto.url }}" alt="{{ tecnico.nome_completo }}">
                                {% else %}
                                <i class="fas fa-user"></i>
                                {% endif %}
                            </div>
                            <div>
                                <div class="d-flex align-items-center">
                                    <h6 class="mb-0">{{ tecnico.nome_completo }}</h6>
                                    <span class="status-badge status-{{ tecnico.status }} ms-2">
                                        {{ tecnico.get_status_display }}
                                    </span>
                                </div>
                                <p class="text-muted mb-1 small">{{ tecnico.codigo }} • {{ tecnico.get_nivel_display }}</p>
                                <div class="d-flex align-items-center small">
                                    <i class="fas fa-clock me-1 {% if tecnico.localizacao_atualizada %}atualizacao-recente{% else %}atualizacao-antiga{% endif %}"></i>
                                    <span class="{% if tecnico.localizacao_atualizada %}atualizacao-recente{% else %}atualizacao-antiga{% endif %}">
                                        {% if tecnico.ultima_atualizacao_localizacao %}
                                            {{ tecnico.ultima_atualizacao_localizacao|timesince }}
                                        {% else %}
                                            Nunca atualizado
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center p-4">
                        <i class="fas fa-map-marked-alt mb-3" style="font-size: 3rem; color: #d1d5db;"></i>
                        <p>Nenhum técnico com localização disponível.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Técnicos sem localização -->
        {% if tecnicos_sem_coordenadas %}
        <div class="card mt-4">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0">Técnicos Sem Localização</h5>
            </div>
            <div class="card-body p-0" style="max-height: 300px; overflow-y: auto;">
                <div class="list-group list-group-flush">
                    {% for tecnico in tecnicos_sem_coordenadas %}
                    <div class="list-group-item p-3 recent-missing" data-tecnico-id="{{ tecnico.id }}">
                        <div class="d-flex">
                            <div class="tecnico-avatar me-3">
                                {% if tecnico.foto %}
                                <img src="{{ tecnico.foto.url }}" alt="{{ tecnico.nome_completo }}">
                                {% else %}
                                <i class="fas fa-user"></i>
                                {% endif %}
                            </div>
                            <div style="flex:1;">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>
                                        <h6 class="mb-0">{{ tecnico.nome_completo }}</h6>
                                        <p class="text-muted mb-0 small">{{ tecnico.codigo }} • {{ tecnico.cidade }}{% if tecnico.estado %}/{{ tecnico.estado }}{% endif %}</p>
                                    </div>
                                    <div class="text-end">
                                        <small class="text-muted">Criado recentemente</small>
                                        <div>
                                            <button class="btn btn-sm btn-outline-success mt-2 btn-try-geocode" data-id="{{ tecnico.id }}">Gerar localização</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <a href="{% url 'tecnicos:detalhe_tecnico' slug=tecnico.slug %}" class="btn btn-sm btn-outline-primary">Ver Detalhes</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Configuração inicial do mapa
        var mapa = L.map('mapa-tecnicos').setView([-23.550520, -46.633308], 10); // São Paulo como padrão
        
        // Adicionar camada do mapa base (CartoDB Positron - claro e limpo, estilo Waze-light)
    // Adicionar camada do mapa base (CartoDB Dark - para dark mode nesta página)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://carto.com/">CARTO</a> &mdash; &copy; OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(mapa);
        
    // Ativar classes de dark-mode na página para aplicar estilos personalizados
    try { document.body.classList.add('dark-mode'); } catch (e) {}
        
        // Armazenar marcadores para referência posterior
        var marcadores = {};
        var bounds = L.latLngBounds();
        var filtroAtivo = 'todos';

    // Pino de referência (sede) removido conforme solicitado
        
        // Função para criar marcadores personalizados
        function criarMarcador(tecnico) {
            // Validar coordenadas antes de tentar criar marcador
            if (tecnico.lat === null || tecnico.lng === null || isNaN(tecnico.lat) || isNaN(tecnico.lng)) {
                return null;
            }

            // Criar o HTML para o marcador personalizado (usar string para compatibilidade com Leaflet)
            var iniciais = (tecnico.nome || '').split(' ').map(function(n){ return n ? n[0] : ''; }).join('').toUpperCase();
            var marcadorHtml = '<div class="custom-marker-tecnico marker-' + tecnico.status + '">' + iniciais + '</div>';

            // Criar ícone personalizado
            var icone = L.divIcon({
                html: marcadorHtml,
                className: 'custom-marker',
                iconSize: [40, 40],
                iconAnchor: [20, 40]
            });

            // Criar marcador com popup
            var marcador = L.marker([parseFloat(tecnico.lat), parseFloat(tecnico.lng)], {icon: icone, status: tecnico.status});
            
            // Popup com informações do técnico
            var popupContent = `
                <div class="popup-content">
                    <h5>${tecnico.nome}</h5>
                    <p><strong>Código:</strong> ${tecnico.codigo}</p>
                    <p><strong>Nível:</strong> ${tecnico.nivel}</p>
                    <p><strong>Status:</strong> 
                        <span class="status-badge status-${tecnico.status}">
                            ${tecnico.status_display}
                        </span>
                    </p>
                    <p><strong>Última atualização:</strong> ${tecnico.ultima_atualizacao}</p>
                    <div class="mt-2">
                        <a href="/tecnicos/${tecnico.slug}/" class="btn btn-sm btn-outline-primary">Ver Detalhes</a>
                        <a href="https://wa.me/55${tecnico.celular}" target="_blank" class="btn btn-sm btn-outline-success"><i class="fab fa-whatsapp me-1"></i>WhatsApp</a>
                    </div>
                </div>
            `;
            
            marcador.bindPopup(popupContent);
            return marcador;
        }
        
        // Adicionar marcadores para cada técnico
        // Carregar técnicos a partir do JSON serializado pelo servidor
        try {
            var tecnicosData = JSON.parse('{{ tecnicos_json|escapejs }}');
            tecnicosData.forEach(function(tecnico) {
                var marcador = criarMarcador(tecnico);
                if (marcador) {
                    marcador.addTo(mapa);
                    marcadores[tecnico.id] = marcador;
                    bounds.extend([parseFloat(tecnico.lat), parseFloat(tecnico.lng)]);
                }
            });
        } catch (e) {
            console.warn('Erro ao parsear tecnicos_json:', e);
        }
        
        // Ajustar o mapa para mostrar todos os marcadores se houver algum
        {% if tecnicos %}
        mapa.fitBounds(bounds, {padding: [50, 50]});
        {% endif %}

        // Estilos padrão para rotas (outline branco + linha principal arredondada)
        var rotaOutlineStyle = { color: '#ffffff', weight: 12, lineCap: 'round', lineJoin: 'round', opacity: 0.95 };
        var rotaMainStyle = { color: '#2a9df4', weight: 6, lineCap: 'round', lineJoin: 'round', opacity: 1.0 };

        // Se o backend fornecer rotas (lista de objetos {coords: [[lat,lng],...], tecnico_id: ...}), desenhar com estilo arredondado
        {% if rotas %}
        var rotasData = {{ rotas|safe }};
        rotasData.forEach(function(r) {
            try {
                // desenhar outline (linha branca maior) e depois a linha principal por cima
                L.polyline(r.coords, rotaOutlineStyle).addTo(mapa);
                L.polyline(r.coords, rotaMainStyle).addTo(mapa);
            } catch (e) {
                console.warn('Erro ao desenhar rota:', e);
            }
        });
        {% endif %}
        
        // Adicionar comportamento de clique para os itens da lista de técnicos
        document.querySelectorAll('.tecnico-item').forEach(function(item) {
            item.addEventListener('click', function() {
                var lat = parseFloat(this.getAttribute('data-lat'));
                var lng = parseFloat(this.getAttribute('data-lng'));
                var id = this.getAttribute('data-id');
                
                // Centralizar o mapa na posição do técnico
                mapa.setView([lat, lng], 15);
                
                // Abrir o popup do marcador
                if (marcadores[id]) {
                    marcadores[id].openPopup();
                }
            });
        });
        
        // Filtros do mapa
        document.querySelectorAll('.mapa-filtro').forEach(function(filtro) {
            filtro.addEventListener('click', function() {
                // Atualizar UI dos filtros
                document.querySelectorAll('.mapa-filtro').forEach(f => f.classList.remove('ativo'));
                this.classList.add('ativo');
                
                // Obter o status selecionado
                filtroAtivo = this.getAttribute('data-status');
                
                // Aplicar filtro nos marcadores do mapa
                Object.values(marcadores).forEach(function(marcador) {
                    if (filtroAtivo === 'todos' || marcador.options.status === filtroAtivo) {
                        mapa.addLayer(marcador);
                    } else {
                        mapa.removeLayer(marcador);
                    }
                });
                
                // Filtrar itens na lista de técnicos
                document.querySelectorAll('.tecnico-item').forEach(function(item) {
                    var itemStatus = item.getAttribute('data-status');
                    if (filtroAtivo === 'todos' || itemStatus === filtroAtivo) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        });
        
        // Atualizar o mapa a cada 60 segundos (opcional)
        setInterval(function() {
            // Aqui você pode implementar uma chamada AJAX para atualizar as posições
            // por enquanto apenas recarregamos a página
            //location.reload();
        }, 60000);

        // Handler para botões de geocode manual (Gerar localização)
        document.querySelectorAll('.btn-try-geocode').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                var tecnicoId = this.getAttribute('data-id');
                var parent = this.closest('.recent-missing');
                // Enviar requisição POST para geocode_tecnico_api
                fetch('{% url "tecnicos:geocode_tecnico_api" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': (document.querySelector('input[name=csrfmiddlewaretoken]') || {}).value || ''
                    },
                    body: 'tecnico_id=' + encodeURIComponent(tecnicoId)
                }).then(function(resp) { return resp.json(); }).then(function(data) {
                    if (data && data.success) {
                        // Adicionar marcador no mapa
                        try {
                            var color = '#2ecc71';
                            var html = `<div class="custom-marker-tecnico" style="background:${color};"></div>`;
                            var marker = L.marker([parseFloat(data.lat), parseFloat(data.lng)], {
                                icon: L.divIcon({ html: html, className: 'custom-div-icon', iconSize: [40,40], iconAnchor: [20,40] })
                            }).addTo(mapa);
                            // tirar o item da lista de sem localização
                            if (parent) parent.remove();
                            // ajustar bounds
                            try { bounds.extend([parseFloat(data.lat), parseFloat(data.lng)]); mapa.fitBounds(bounds, {padding:[50,50]}); } catch(e){}
                            alert('Localização gerada e adicionada ao mapa.');
                        } catch (e) {
                            console.warn('Erro ao adicionar marcador:', e);
                        }
                    } else {
                        alert(data.message || 'Não foi possível gerar localização para este técnico.');
                    }
                }).catch(function(err){
                    console.error('Erro na requisição de geocode:', err);
                    alert('Erro ao tentar gerar localização. Veja o console para detalhes.');
                });
            });
        });
    });
</script>
{% endblock %} 